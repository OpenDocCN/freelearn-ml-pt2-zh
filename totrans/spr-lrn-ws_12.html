<html><head></head><body>
		<br/>
		<p class="style0">4. Autoregression</p>
		<div style="page-break-before: always;"/>
	

		<br/>
		<h4 class="style0">Activity 4.01: Autoregression Model Based on Periodic Data</h4>
		<br/>
		<p class="style0">Import the necessary packages, classes, and libraries.</p>
		<br/>
		<h4 class="style2">Note</h4>
		<br/>
		<p class="style2">This activity will work on an earlier version of pandas, ensure that you downgrade the version of pandas using the command:</p>
		<br/>
		<p class="style2">pip install pandas==0.24.2</p>
		<br/>
		<p class="style0">The code is as follows:</p>
		<br/>
		<p class="style0">import pandas as pd</p>
		<br/>
		<p class="style0">import numpy as np</p>
		<br/>
		<p class="style0">from statsmodels.tsa.ar_model import AR</p>
		<br/>
		<p class="style0">from statsmodels.graphics.tsaplots import plot_acf</p>
		<br/>
		<p class="style0">import matplotlib.pyplot as plt</p>
		<br/>
		<p class="style0">Load the data and convert the Date column to datetime:</p>
		<br/>
		<p class="style0">df = pd.read_csv('../Datasets/austin_weather.csv')</p>
		<br/>
		<p class="style0">df.Date = pd.to_datetime(df.Date)</p>
		<br/>
		<p class="style0">print(df.head())</p>
		<br/>
		<p class="style0">print(df.tail())</p>
		<br/>
		<p class="style0">The output for df.head() should look as follows:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-6NRIUD3J.jpg" alt="Figure 4.22: Output for df.head()&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.22: Output for df.head()</p>
		<br/>
		<p class="style0">The output for df.tail() should look as follows:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-79U4JNOU.jpg" alt="Figure 4.23: Output for df.tail()&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.23: Output for df.tail()</p>
		<br/>
		<p class="style0">Plot the complete set of average temperature values (df.TempAvgF) with Date on the x axis:</p>
		<br/>
		<p class="style0">fig, ax = plt.subplots(figsize = (10, 7))</p>
		<br/>
		<p class="style0">ax.scatter(df.Date, df.TempAvgF)</p>
		<br/>
		<p class="style0">plt.show()</p>
		<br/>
		<p class="style0">The output will be as follows:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-MN96GL2H.jpg" alt="Figure 4.24: Plot of Austin temperature data over several years&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.24: Plot of Austin temperature data over several years</p>
		<br/>
		<p class="style0">Note the periodic behavior of the data. It's sensible given that temperature varies over an annual weather cycle.</p>
		<br/>
		<p class="style0">Construct an autocorrelation plot (using statsmodels) to see whether the average temperature can be used with an autoregression model. Where is the lag acceptable and where is it not for an autoregression model? Check the following code:</p>
		<br/>
		<p class="style0">max_lag = 730</p>
		<br/>
		<p class="style0">fig, ax = plt.subplots(figsize = (10, 7))</p>
		<br/>
		<p class="style0">acf_plot = plot_acf(x = df.TempAvgF, ax = ax, lags = max_lag, \</p>
		<br/>
		<p class="style0">                    use_vlines = False, alpha = 0.9, \</p>
		<br/>
		<p class="style0">                    title = 'Autocorrelation of Austin Temperature '\</p>
		<br/>
		<p class="style0">                            'vs. lag')</p>
		<br/>
		<p class="style0">ax.grid(True)</p>
		<br/>
		<p class="style0">ax.text(280, -0.01, '90% confidence interval', fontsize = 9)</p>
		<br/>
		<p class="style0">ax.set_xlabel('Lag', fontsize = 14)</p>
		<br/>
		<p class="style0">ax.tick_params(axis = 'both', labelsize = 12)</p>
		<br/>
		<p class="style0">The plot should look as follows:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-S6EAOA1L.jpg" alt="Figure 4.25: Autocorrelation versus lag (days)&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.25: Autocorrelation versus lag (days)</p>
		<br/>
		<p class="style0">The lag is acceptable only when the autocorrelation line lies outside the 90% confidence bounds, as represented by the shaded area. Note that, in this case, instead of a steadily decreasing ACF value, we see peaks and valleys. This should match your intuition because the original data shows a periodic pattern. Also, note that there are very strong positive and negative correlations. It is possible to leverage the strong negative correlation at around 180 days (half a year), but that is a more advanced time series topic beyond our scope here. The main takeaway from Figure 4.25 is that there is a very steep drop in the ACF after short lag times. Now, use the same methods as before to look at the lag plots versus the ACF.</p>
		<br/>
		<p class="style0">Get the actual ACF values:</p>
		<br/>
		<p class="style0">corr0 = np.correlate(df.TempAvgF[0: ] - df.TempAvgF.mean(), \</p>
		<br/>
		<p class="style0">        df.TempAvgF[0: ] - df.TempAvgF.mean(), mode = 'valid')</p>
		<br/>
		<p class="style0">corrs = [np.correlate(df.TempAvgF[:(df.TempAvgF.shape[0] - i)] \</p>
		<br/>
		<p class="style0">         - df.TempAvgF.mean(), df.TempAvgF[i: ] \</p>
		<br/>
		<p class="style0">         - df.TempAvgF.mean(), mode = 'valid')</p>
		<br/>
		<p class="style0">         for i in range(max_lag)] / corr0</p>
		<br/>
		<p class="style0">We need the same utility grid plotting function we developed in Exercise 4.01, Creating an Autoregression Model:</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">utility function to plot out a range of</p>
		<br/>
		<p class="style0">plots depicting self-correlation</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">def plot_lag_grid(series, corrs, axis_min, axis_max, \</p>
		<br/>
		<p class="style0">                  num_plots, total_lag, n_rows, n_cols):</p>
		<br/>
		<p class="style0">    lag_step = int(total_lag / num_plots)</p>
		<br/>
		<p class="style0">    fig = plt.figure(figsize = (18, 16))</p>
		<br/>
		<p class="style0">    for i, var_name in enumerate(range(num_plots)):</p>
		<br/>
		<p class="style0">        corr = corrs[lag_step * i]</p>
		<br/>
		<p class="style0">        ax = fig.add_subplot(n_rows, n_cols, i + 1)</p>
		<br/>
		<p class="style0">        ax.scatter(series, series.shift(lag_step * i))</p>
		<br/>
		<p class="style0">        ax.set_xlim(axis_min, axis_max)</p>
		<br/>
		<p class="style0">        ax.set_ylim(axis_min, axis_max)</p>
		<br/>
		<p class="style0">        ax.set_title('lag = ' + str(lag_step * i))</p>
		<br/>
		<p class="style0">        ax.text(axis_min + 0.05 * (axis_max - axis_min), \</p>
		<br/>
		<p class="style0">                axis_max - 0.05 * (axis_max - axis_min), \</p>
		<br/>
		<p class="style0">                'correlation = ' + str(round(corr[0], 3)))</p>
		<br/>
		<p class="style0">    fig.tight_layout()</p>
		<br/>
		<p class="style0">    plt.show()</p>
		<br/>
		<p class="style0">Now, given that we have an indication that we are interested in short lags, but also that there are strong correlations around a half year and a full year, let's look at two timescales:</p>
		<br/>
		<p class="style0">plot_lag_grid(df.TempAvgF, corrs, df.TempAvgF.min(), \</p>
		<br/>
		<p class="style0">              df.TempAvgF.max(), 9, 45, 3, 3)</p>
		<br/>
		<p class="style0">plot_lag_grid(df.TempAvgF, corrs, df.TempAvgF.min(), \</p>
		<br/>
		<p class="style0">              df.TempAvgF.max(), 9, 405, 3, 3)</p>
		<br/>
		<p class="style0">The output for short lags will be as follows:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-I4WY2ZXG.jpg" alt="Figure 4.26: Lag plots with short lags&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.26: Lag plots with short lags</p>
		<br/>
		<p class="style0">The output for longer lags will be as follows:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-QG5SLXLX.jpg" alt="Figure 4.27: Lag plots with longer lags&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.27: Lag plots with longer lags</p>
		<br/>
		<p class="style0">We can see from Figure 4.26 that the correlation degrades consistently from lag 5 to 40. Over a longer timescale, Figure 4.27 shows that the correlation degrades rapidly and then improves as we near a lag of one year. This matches the intuition from the plot of the raw data (side note—this should reinforce the importance of EDA).</p>
		<br/>
		<p class="style0">We would expect from our initial analysis that the autoregression model would focus on fairly short lags. Let's use the statsmodelsAR function to build a model and see the results:</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">statsmodels AR function builds an autoregression model</p>
		<br/>
		<p class="style0">using all the defaults, it will determine the max lag</p>
		<br/>
		<p class="style0">and provide all the model coefficients</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">model = AR(df.TempAvgF)</p>
		<br/>
		<p class="style0">model_fit = model.fit()</p>
		<br/>
		<p class="style0"># model fit now contains all the model information</p>
		<br/>
		<p class="style0">max_lag = model_fit.k_ar</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">note that by using defaults, the maximum lag is</p>
		<br/>
		<p class="style0">computed as round(12*(nobs/100.)**(1/4.))</p>
		<br/>
		<p class="style0">see https://www.statsmodels.org/devel/generated/statsmodels.tsa.ar_model.AR.fit.html#statsmodels.tsa.ar_model.AR.fit</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">print('Max Lag: ' + str(max_lag))</p>
		<br/>
		<p class="style0">print('Coefficients: \n' + str(model_fit.params))</p>
		<br/>
		<p class="style0"># how far into the future we want to predict</p>
		<br/>
		<p class="style0">max_forecast = 365</p>
		<br/>
		<p class="style0"># generate predictions from the model</p>
		<br/>
		<p class="style0">pred_temp = pd.DataFrame({'pred_temp': \</p>
		<br/>
		<p class="style0">                          model_fit.predict(start = max_lag, \</p>
		<br/>
		<p class="style0">                                            end = df.shape[0] \</p>
		<br/>
		<p class="style0">                                            + max_forecast - 1)})</p>
		<br/>
		<p class="style0"># attach the dates for visualization</p>
		<br/>
		<p class="style0">pred_temp['Date'] = df.loc[pred_temp.index, 'Date'].reindex()</p>
		<br/>
		<p class="style0">pred_temp.loc[(max(df.index) + 1):, 'Date'] = \</p>
		<br/>
		<p class="style0">    pd.to_datetime([max(df.Date) \</p>
		<br/>
		<p class="style0">                    + pd.Timedelta(days = i)</p>
		<br/>
		<p class="style0">                    for i in range(1, max_forecast + 1)])</p>
		<br/>
		<p class="style0">The result is a model with lags of up to 23 days:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-0SLEXDL5.jpg" alt="Figure 4.28: AR model of Austin temperature data&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.28: AR model of Austin temperature data</p>
		<br/>
		<p class="style0">Plot the predictions, forecast, and raw data on the same plot:</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">visualize the predictions overlaid on the real data</p>
		<br/>
		<p class="style0">as well as the extrapolation to the future</p>
		<br/>
		<p class="style0">"""</p>
		<br/>
		<p class="style0">fig, ax = plt.subplots(figsize = (10, 7))</p>
		<br/>
		<p class="style0">ax.plot(df.Date, df.TempAvgF, c = "blue", \</p>
		<br/>
		<p class="style0">        linewidth = 4, label = 'Actual Average Temperature')</p>
		<br/>
		<p class="style0">ax.plot(pred_temp.loc[0 : len(df.TempAvgF), 'Date'], \</p>
		<br/>
		<p class="style0">        pred_temp.loc[0 : len(df.TempAvgF), 'pred_temp'], \</p>
		<br/>
		<p class="style0">        c = "yellow", linewidth = 0.5, \</p>
		<br/>
		<p class="style0">        label = 'Predicted Temperature')</p>
		<br/>
		<p class="style0">ax.plot(pred_temp.loc[len(df.TempAvgF):, 'Date'], \</p>
		<br/>
		<p class="style0">        pred_temp.loc[len(df.TempAvgF):, 'pred_temp'], \</p>
		<br/>
		<p class="style0">        c = "red", linewidth = 2, \</p>
		<br/>
		<p class="style0">        label = 'Forecast Temperature')</p>
		<br/>
		<p class="style0">ax.set_xlabel('Date', fontsize = 14)</p>
		<br/>
		<p class="style0">ax.tick_params(axis = 'both', labelsize = 12)</p>
		<br/>
		<p class="style0">ax.set_title('Austin Texas Average Daily Temperature')</p>
		<br/>
		<p class="style0">ax.tick_params(axis = 'both', labelsize = 12)</p>
		<br/>
		<p class="style0">ax.legend()</p>
		<br/>
		<p class="style0">plt.show()</p>
		<br/>
		<p class="style0">The output will be as follows:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-62BMHFHF.jpg" alt="Figure 4.29: Austin temperature predictions and forecast&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.29: Austin temperature predictions and forecast</p>
		<br/>
		<p class="style0">Let's zoom in on the end of the data, on the last 30 days of the data and on the first 30 forecast values:</p>
		<br/>
		<p class="style0"># zoom in on a window near the end of the raw data</p>
		<br/>
		<p class="style0">window = 30</p>
		<br/>
		<p class="style0">fig, ax = plt.subplots(figsize = (10, 7))</p>
		<br/>
		<p class="style0">ax.plot(df.Date[(len(df.TempAvgF) - window) : len(df.TempAvgF)], \</p>
		<br/>
		<p class="style0">        df.TempAvgF[(len(df.TempAvgF) - window) : \</p>
		<br/>
		<p class="style0">                     len(df.TempAvgF)], \</p>
		<br/>
		<p class="style0">        c = "blue", linewidth = 4, \</p>
		<br/>
		<p class="style0">        label = 'Actual Average Temperature')</p>
		<br/>
		<p class="style0">ax.plot(pred_temp.Date.iloc[(-max_forecast \</p>
		<br/>
		<p class="style0">                             - window):(-max_forecast)], \</p>
		<br/>
		<p class="style0">        pred_temp.pred_temp.iloc[(-max_forecast \</p>
		<br/>
		<p class="style0">                                  - window):(-max_forecast)], \</p>
		<br/>
		<p class="style0">        c = "red", linewidth = 2, label = 'Predicted Temperature')</p>
		<br/>
		<p class="style0">ax.plot(pred_temp.loc[len(df.TempAvgF):\</p>
		<br/>
		<p class="style0">                     (len(df.TempAvgF) + window), 'Date'], \</p>
		<br/>
		<p class="style0">        pred_temp.loc[len(df.TempAvgF):\</p>
		<br/>
		<p class="style0">                     (len(df.TempAvgF) + window), 'pred_temp'], \</p>
		<br/>
		<p class="style0">        c = "green", linewidth = 2, label = 'Forecast Temperature')</p>
		<br/>
		<p class="style0">ax.set_xlabel('Date', fontsize = 14)</p>
		<br/>
		<p class="style0">ax.tick_params(axis = 'both', labelsize = 12)</p>
		<br/>
		<p class="style0">ax.set_title('Austin Texas Average Daily Temperature')</p>
		<br/>
		<p class="style0">ax.tick_params(axis = 'both', labelsize = 12)</p>
		<br/>
		<p class="style0">ax.set_xticks(pd.date_range(df.Date[len(df.TempAvgF) - window], \</p>
		<br/>
		<p class="style0">                            df.Date[len(df.TempAvgF) - 1] \</p>
		<br/>
		<p class="style0">                            + pd.Timedelta(days = window), 5))</p>
		<br/>
		<p class="style0">ax.legend()</p>
		<br/>
		<p class="style0">plt.show()</p>
		<br/>
		<p class="style0">We will get the following output:</p>
		<br style="line-height: 1,4"/>
		<div>
			<img src="../Images/image-55LKGBXK.jpg" alt="Figure 4.30: Detail of predictions near the end of the data&#13;&#10;" height="100%"/>
		</div>
		<br/>
		<br/>
		<p class="style0" style="text-align: center">Figure 4.30: Detail of predictions near the end of the data</p>
		<br/>
		<h4 class="style2">Note</h4>
		<br/>
		<p class="style2">To access the source code for this specific section, please refer to https://packt.live/3hOXUQL.</p>
		<br/>
		<p class="style2">You can also run this example online at https://packt.live/313Vmbl. You must execute the entire Notebook in order to get the desired result.</p>
		<br/>
		<p class="style2">Now that the activity is successfully completed, upgrade the version of pandas to continue to smoothly run the exercises and activities present in the rest of the book. To upgrade pandas, run:</p>
		<br/>
		<p class="style2">pip install pandas==1.0.3</p>
		<div style="page-break-before: always;"/>
	</body></html>